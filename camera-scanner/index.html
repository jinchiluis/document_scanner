<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Scanner Diagnostic</title>
  <style>
    body { font-family: system-ui, sans-serif; background: #f5f5f5; margin: 0; padding: 20px; text-align: center; }
    #video { max-width: 90vw; max-height: 50vh; border: 3px solid #333; border-radius: 10px; background: #000; }
    #canvas { max-width: 90vw; max-height: 30vh; border: 3px solid #00f; border-radius: 10px; margin-top: 10px; display: none; }
    button { font-size: 1.1rem; padding: 15px 30px; margin: 10px 5px; border-radius: 8px; border: none; background: #007bff; color: #fff; cursor: pointer; }
    button:disabled { background: #ccc; }
    #log { background: #000; color: #0f0; padding: 15px; border-radius: 8px; font-family: monospace; text-align: left; margin: 20px auto; max-width: 600px; white-space: pre-wrap; font-size: 12px; max-height: 300px; overflow-y: auto; }
    .error { color: #f00; }
    .success { color: #0f0; }
    .warning { color: #ff0; }
  </style>
</head>
<body>
  <h1>ðŸ“¸ Scanner Diagnostic</h1>
  
  <video id="video" autoplay playsinline muted></video>
  <br>
  <canvas id="canvas"></canvas>
  
  <div>
    <button id="test-btn" onclick="runTests()">Run Diagnostics</button>
    <button id="capture-btn" onclick="testCapture()" disabled>Test Capture</button>
    <button id="opencv-btn" onclick="testOpenCV()" disabled>Test OpenCV</button>
  </div>
  
  <div id="log">Diagnostic Log:
==============
</div>

  <script src="https://docs.opencv.org/4.x/opencv.js"></script>
  <script>
    let video = document.getElementById('video');
    let canvas = document.getElementById('canvas');
    let ctx = canvas.getContext('2d');
    let log = document.getElementById('log');
    let captureBtn = document.getElementById('capture-btn');
    let opencvBtn = document.getElementById('opencv-btn');
    
    function addLog(msg, type = '') {
      const timestamp = new Date().toLocaleTimeString();
      const className = type ? ` class="${type}"` : '';
      log.innerHTML += `<span${className}>[${timestamp}] ${msg}</span>\n`;
      log.scrollTop = log.scrollHeight;
    }
    
    async function runTests() {
      addLog('Starting diagnostics...', 'warning');
      
      // Test 1: Browser capabilities
      addLog('\n1. BROWSER CHECKS:', 'warning');
      addLog(`User Agent: ${navigator.userAgent.substring(0, 50)}...`);
      addLog(`Camera API: ${navigator.mediaDevices && navigator.mediaDevices.getUserMedia ? 'YES' : 'NO'}`, 
        navigator.mediaDevices ? 'success' : 'error');
      
      // Test 2: Camera access
      addLog('\n2. CAMERA TEST:', 'warning');
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ 
          video: { facingMode: 'environment' } 
        });
        video.srcObject = stream;
        
        video.onloadedmetadata = () => {
          video.play();
          setTimeout(() => {
            addLog(`Camera initialized: ${video.videoWidth}x${video.videoHeight}`, 'success');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            captureBtn.disabled = false;
          }, 1000);
        };
      } catch (err) {
        addLog(`Camera error: ${err.message}`, 'error');
      }
      
      // Test 3: OpenCV status
      addLog('\n3. OPENCV CHECK:', 'warning');
      checkOpenCV();
    }
    
    function checkOpenCV() {
      if (typeof cv !== 'undefined') {
        try {
          // Test if cv is actually functional
          let testMat = new cv.Mat();
          testMat.delete();
          addLog('OpenCV loaded and functional!', 'success');
          addLog(`OpenCV build: ${cv.getBuildInformation().substring(0, 100)}...`);
          opencvBtn.disabled = false;
        } catch (e) {
          addLog('OpenCV loaded but not functional: ' + e.message, 'error');
        }
      } else {
        addLog('OpenCV not loaded yet, waiting...', 'warning');
        setTimeout(checkOpenCV, 1000);
      }
    }
    
    function testCapture() {
      addLog('\n4. CAPTURE TEST:', 'warning');
      try {
        ctx.drawImage(video, 0, 0);
        canvas.style.display = 'block';
        
        // Get some pixels to verify
        const imageData = ctx.getImageData(0, 0, 10, 10);
        const hasData = Array.from(imageData.data).some(v => v > 0);
        
        if (hasData) {
          addLog('Canvas capture successful! Image data present.', 'success');
          addLog(`First pixel RGBA: [${imageData.data[0]}, ${imageData.data[1]}, ${imageData.data[2]}, ${imageData.data[3]}]`);
        } else {
          addLog('Canvas capture failed - all pixels are black', 'error');
        }
      } catch (err) {
        addLog(`Capture error: ${err.message}`, 'error');
      }
    }
    
    function testOpenCV() {
      addLog('\n5. OPENCV PROCESSING TEST:', 'warning');
      if (typeof cv === 'undefined') {
        addLog('OpenCV not loaded!', 'error');
        return;
      }
      
      try {
        // Capture frame
        ctx.drawImage(video, 0, 0);
        let imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        
        // Create Mat from image
        addLog('Creating Mat from image data...');
        let src = cv.matFromImageData(imageData);
        addLog(`Source Mat: ${src.rows}x${src.cols}, channels: ${src.channels()}`, 'success');
        
        // Convert to gray
        addLog('Converting to grayscale...');
        let gray = new cv.Mat();
        cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY);
        addLog(`Gray Mat: ${gray.rows}x${gray.cols}, channels: ${gray.channels()}`, 'success');
        
        // Try Canny
        addLog('Applying Canny edge detection...');
        let edges = new cv.Mat();
        cv.Canny(gray, edges, 50, 150);
        addLog(`Edges Mat: ${edges.rows}x${edges.cols}`, 'success');
        
        // Count non-zero pixels
        let nonZero = cv.countNonZero(edges);
        addLog(`Non-zero edge pixels: ${nonZero} (${(nonZero / (edges.rows * edges.cols) * 100).toFixed(2)}%)`, 
          nonZero > 0 ? 'success' : 'warning');
        
        // Find contours
        addLog('Finding contours...');
        let contours = new cv.MatVector();
        let hierarchy = new cv.Mat();
        cv.findContours(edges, contours, hierarchy, cv.RETR_EXTERNAL, cv.CHAIN_APPROX_SIMPLE);
        addLog(`Contours found: ${contours.size()}`, contours.size() > 0 ? 'success' : 'warning');
        
        // Show edges on canvas
        cv.imshow(canvas, edges);
        addLog('Edge detection result shown on canvas', 'success');
        
        // Cleanup
        src.delete();
        gray.delete();
        edges.delete();
        contours.delete();
        hierarchy.delete();
        
        addLog('\nOpenCV is working correctly! âœ…', 'success');
        
      } catch (err) {
        addLog(`OpenCV error: ${err.message}`, 'error');
        addLog(`Stack: ${err.stack}`, 'error');
      }
    }
    
    // Auto-run tests when page loads
    window.onload = () => {
      addLog('Page loaded, waiting for user to start diagnostics...');
    };
    
    // Set up OpenCV callback
    if (typeof cv !== 'undefined') {
      cv['onRuntimeInitialized'] = () => {
        addLog('OpenCV runtime initialized!', 'success');
      };
    }
  </script>
</body>
</html>
